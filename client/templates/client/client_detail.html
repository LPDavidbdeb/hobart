{% extends 'base.html' %}
{% load django_bootstrap5 %}

{% block title %}Client: {{ client.account_number }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h1 class="mb-0">Client Details: {{ client.account_number }}</h1>
        </div>
        <div class="card-body">
            <div id="status-message" class="alert" style="display: none;" role="alert"></div>

            <table class="table table-bordered">
                <tbody>
                    <tr><th style="width: 25%;">Client Group</th><td>{{ client.client_group.name }}</td></tr>
                    <tr><th>Territory</th><td>{{ client.territory.code|default:"---" }}</td></tr>
                    <tr><th>Industry Code</th><td>{{ client.industry_code.code|default:"---" }}</td></tr>
                    <tr><th>Customer Type Code</th><td>{{ client.customer_type_code.code|default:"---" }}</td></tr>
                    <tr><th>Industry Sub-Code</th><td>{{ client.industry_sub_code.code|default:"---" }}</td></tr>
                </tbody>
            </table>
            <a href="{% url 'client:client_list' %}" class="btn btn-secondary">Back to Client List</a>
        </div>
    </div>

    <!-- Address Management Card -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h2 class="mb-0">Address Management</h2>
        </div>
        <div class="card-body">
            <div id="address-status-message" class="alert" style="display: none;" role="alert"></div>
            
            <div id="address-header-container" class="d-flex align-items-center mb-2">
                <h5 class="mb-0">Current Geocoded Address</h5>
                {% if client.address_status %}
                    <span class="badge {{ client.address_status.badge_class }} ms-2">{{ client.address_status.name }}</span>
                    {% if client.address_status.name == 'INCOMPLETE' and client.address %}
                        {% with reasons=client.address.get_degeneracy_reasons %}
                            {% if reasons %}
                                <small class="ms-2 text-muted"> (Missing: {{ reasons|join:", " }})</small>
                            {% endif %}
                        {% endwith %}
                    {% endif %}
                {% endif %}
            </div>

            <div id="current-address-display" class="mb-3 p-2 bg-light rounded">
                {% if client.address %}
                    <p class="mb-0">{{ client.address.formatted }}</p>
                {% else %}
                    <p class="mb-0 text-muted">No geocoded address assigned.</p>
                {% endif %}
            </div>

            <hr>

            <h5>Manually Edit Original Address Fields</h5>
            <form method="post" class="mb-4">
                {% csrf_token %}
                {% bootstrap_form client_address_edit_form %}
                <button type="submit" class="btn btn-warning">Update Original Address</button>
            </form>

            <hr>

            <h5>Search and Assign Geocoded Address</h5>
            <div class="position-relative">
                <input type="text" id="address-autocomplete-input" class="form-control" placeholder="Start typing an address...">
                <div id="address-autocomplete-results" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('address-autocomplete-input');
    const resultsDiv = document.getElementById('address-autocomplete-results');
    const statusDiv = document.getElementById('address-status-message');
    const clientPk = "{{ client.pk }}";
    let debounceTimeout;

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    searchInput.addEventListener('keyup', function() {
        clearTimeout(debounceTimeout);
        const query = searchInput.value;
        if (query.length < 3) { resultsDiv.innerHTML = ''; return; }

        debounceTimeout = setTimeout(() => {
            fetch(`{% url "address:search_address_api" %}?query=${encodeURIComponent(query)}&client_pk=${clientPk}`)
                .then(response => response.json())
                .then(data => {
                    resultsDiv.innerHTML = '';
                    if (data.suggestions && data.suggestions.length > 0) {
                        data.suggestions.forEach(suggestion => {
                            const item = document.createElement('a');
                            item.href = '#';
                            item.className = 'list-group-item list-group-item-action';
                            item.innerHTML = `${suggestion.formatted_address} <span class="badge bg-secondary">${suggestion.source}</span>`;
                            item.dataset.placeId = suggestion.place_id;
                            resultsDiv.appendChild(item);
                        });
                    }
                });
        }, 300);
    });

    resultsDiv.addEventListener('click', function(e) {
        e.preventDefault();
        const target = e.target.closest('a');
        if (target) {
            const placeId = target.dataset.placeId;

            resultsDiv.innerHTML = '';
            searchInput.value = '';

            const payload = {
                client_pk: clientPk,
                place_id: placeId
            };

            fetch(`{% url "address:set_client_address_api" %}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // --- Dynamic Update Logic ---
                    const currentAddressDiv = document.getElementById('current-address-display');
                    currentAddressDiv.innerHTML = `<p class="mb-0">${data.formatted_address}</p>`;

                    const addressHeaderContainer = document.getElementById('address-header-container');
                    let reasonsHTML = '';
                    if (data.status.name === 'INCOMPLETE' && data.status.reasons.length > 0) {
                        reasonsHTML = `<small class="ms-2 text-muted"> (Missing: ${data.status.reasons.join(", ")})</small>`;
                    }
                    addressHeaderContainer.innerHTML = `
                        <h5 class="mb-0">Current Geocoded Address</h5>
                        <span class="badge ${data.status.badge_class} ms-2">${data.status.name}</span>
                        ${reasonsHTML}
                    `;

                    statusDiv.className = 'alert alert-success';
                    statusDiv.textContent = 'Address updated successfully!';
                    statusDiv.style.display = 'block';
                } else {
                    statusDiv.className = 'alert alert-danger';
                    statusDiv.textContent = `Error: ${data.error}`;
                    statusDiv.style.display = 'block';
                }
                setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
            })
            .catch(error => {
                statusDiv.className = 'alert alert-danger';
                statusDiv.textContent = 'A network error occurred.';
                statusDiv.style.display = 'block';
                setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
            });
        }
    });

    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target)) {
            resultsDiv.innerHTML = '';
        }
    });
});
</script>
{% endblock %}
