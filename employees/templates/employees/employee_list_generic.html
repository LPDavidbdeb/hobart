{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center">
            <h2 class="mb-0">{{ page_title }}</h2>
            <a href="#" class="ms-3" data-bs-toggle="modal" data-bs-target="#helpModal" aria-label="Help with creation rules">
                <i class="bi bi-question-circle-fill fs-4"></i>
            </a>
        </div>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">
            Add {{ role_name }}
        </button>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>Full Name</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Code</th>
                    <th>Address Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for employee in object_list %}
                <tr>
                    <td>{{ employee.user.get_full_name }}</td>
                    <td><strong>{{ employee.user.username }}</strong></td>
                    <td>{{ employee.user.email }}</td>
                    <td>{{ employee.code }}</td>
                    <td>
                        {% if employee.address_status %}
                            <span class="badge {{ employee.address_status.badge_class }}">{{ employee.address_status.name }}</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{% url 'employees:employee_detail' pk=employee.pk %}" class="btn btn-sm btn-info">View</a>
                        <a href="{% url 'employees:edit_employee' pk=employee.pk %}" class="btn btn-sm btn-outline-secondary">Edit</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center">No employees with the role '{{ role_name }}' found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add Employee Modal -->
<div class="modal fade" id="addEmployeeModal" tabindex="-1" aria-labelledby="addEmployeeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addEmployeeModalLabel">Add New {{ role_name }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="post" action="{{ request.path }}">
            {% csrf_token %}
            {{ form.as_p }}
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary">Save {{ role_name }}</button>
            </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Help Modal (Content is generic and can be shared) -->
<div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="helpModalLabel">Règles de Création Automatique des Employés</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Lors de la création d'un nouvel employé, plusieurs champs sont générés automatiquement pour assurer la cohérence et la sécurité.</p>
        
        <h6>Nom d'utilisateur (Username)</h6>
        <ul>
            <li>Généré à partir de la <strong>première lettre du prénom</strong> et des <strong>8 premières lettres du nom de famille</strong>.</li>
            <li>Exemple : <em>Jean-Claude Van Damme</em> → <code>jvandamme</code>.</li>
            <li>Le système assure que chaque nom d'utilisateur est unique. Si <code>jvandamme</code> existe, il essaiera <code>jvandamme1</code>, <code>jvandamme2</code>, etc.</li>
        </ul>

        <h6>Adresse Courriel (Email)</h6>
        <ul>
            <li>Générée en joignant le prénom et le nom de famille avec un point, suivi de <code>@hobart.ca</code>.</li>
            <li>Les caractères accentués (comme <code>é</code>, <code>à</code>) sont remplacés par leur équivalent simple (e.g., <code>e</code>, <code>a</code>).</li>
            <li>Les espaces et les tirets sont supprimés.</li>
            <li>Exemple : <em>Dave Doré</em> → <code>dave.dore@hobart.ca</code>.</li>
            <li>Le système assure que chaque adresse courriel est unique.</li>
        </ul>

        <h6>Code Employé</h6>
        <ul>
            <li>Généré à partir de la <strong>première lettre du prénom</strong> et de la <strong>première lettre du nom de famille</strong>.</li>
            <li>Exemple : <em>Dave Doré</em> → <code>DD</code>.</li>
            <li>Le système assure que chaque code est unique en ajoutant un numéro à la fin. Si <code>DD1</code> et <code>DD2</code> existent, le prochain sera <code>DD3</code>.</li>
        </ul>

        <h6>Mot de passe (Password)</h6>
        <ul>
            <li><strong>Aucun mot de passe n'est défini à la création.</strong> Le compte est créé avec un mot de passe inutilisable.</li>
            <li>L'employé devra utiliser la fonction "mot de passe oublié" pour définir son propre mot de passe lors de sa première connexion.</li>
        </ul>

        <p class="mt-3">La modification du nom ou du prénom d'un employé via le bouton "Edit" régénérera automatiquement ces trois champs pour maintenir la cohérence.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

{% if form_errors %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var addModal = new bootstrap.Modal(document.getElementById('addEmployeeModal'));
        addModal.show();
    });
</script>
{% endif %}

{% endblock %}
